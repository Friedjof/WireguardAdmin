{% extends "base.html" %}

{% block title %}Edit {{ peer.name }} - WireGuard Manager{% endblock %}

{% block head %}
<style>
.console-container {
    background: #1a1a1a;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    max-height: 500px;
    overflow-y: auto;
}

.console-content {
    padding: 20px;
    color: #00ff00;
    background: #000;
    border: none;
    min-height: 400px;
}

.console-line {
    display: block;
    padding: 2px 8px;
    margin: 1px 0;
    border-radius: 3px;
    cursor: pointer;
    transition: background-color 0.2s;
    white-space: pre-wrap;
    word-break: break-all;
}

.console-line:hover {
    background-color: rgba(0, 255, 0, 0.1);
}

.console-line.comment {
    color: #888;
    font-style: italic;
}

.console-line.command {
    color: #00ff00;
}

.console-line.rule-command {
    color: #00ddff;
}

.console-line.copied {
    background-color: rgba(0, 255, 0, 0.3) !important;
    animation: pulse 0.5s;
}

@keyframes pulse {
    0% { background-color: rgba(0, 255, 0, 0.3); }
    50% { background-color: rgba(0, 255, 0, 0.6); }
    100% { background-color: rgba(0, 255, 0, 0.3); }
}

.console-container::-webkit-scrollbar {
    width: 8px;
}

.console-container::-webkit-scrollbar-track {
    background: #1a1a1a;
}

.console-container::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}

.console-container::-webkit-scrollbar-thumb:hover {
    background: #777;
}

.terminal-prompt {
    color: #ffaa00;
    font-weight: bold;
}

.terminal-path {
    color: #00aaff;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-edit me-2"></i>Edit Peer: {{ peer.name }}</h1>
    <div class="btn-group" role="group">
        <a href="{{ url_for('show_peer', peer_id=peer.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Details
        </a>
        <a href="{{ url_for('list_peers') }}" class="btn btn-outline-secondary">
            <i class="fas fa-list me-1"></i>All Peers
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user-edit me-2"></i>Update Peer Configuration</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('update_peer', peer_id=peer.id) }}" method="post">
                    <div class="mb-3">
                        <label for="name" class="form-label">
                            <i class="fas fa-tag me-1"></i>Peer Name <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="name" 
                               name="name" 
                               value="{{ peer.name }}"
                               required 
                               pattern="[a-zA-Z0-9_-]+"
                               title="Only letters, numbers, hyphens and underscores allowed">
                        <div class="form-text">A unique name to identify this peer (alphanumeric, -, _ only)</div>
                    </div>

                    <div class="mb-3">
                        <label for="public_key" class="form-label">
                            <i class="fas fa-key me-1"></i>Public Key <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control font-monospace" 
                                   id="public_key" 
                                   name="public_key" 
                                   value="{{ peer.public_key }}"
                                   required>
                            <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard('{{ peer.public_key }}', this)" title="Copy current key">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="form-text">The WireGuard public key for this peer</div>
                    </div>

                    <div class="mb-3">
                        <label for="assigned_ip" class="form-label">
                            <i class="fas fa-network-wired me-1"></i>Assigned IP Address
                        </label>
                        <input type="text" 
                               class="form-control font-monospace"
                               id="assigned_ip" 
                               value="{{ peer.assigned_ip or 'Not assigned' }}"
                               readonly>
                        <div class="form-text">This IP is automatically assigned to the peer (cannot be changed)</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-plus-circle me-1"></i>Additional Allowed IPs <span class="text-muted">(Optional)</span>
                        </label>
                        <div id="allowed-ips-container">
                            <!-- Dynamic IP input fields will be populated here -->
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addIpField()">
                            <i class="fas fa-plus me-1"></i>Add IP Range
                        </button>
                        <div class="form-text mt-2">
                            IP ranges this peer should be allowed to access (CIDR notation). 
                            <br><strong>Note:</strong> IPs must be outside the VPN subnet and cannot overlap with other peers.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="endpoint" class="form-label">
                            <i class="fas fa-globe me-1"></i>Endpoint <span class="text-muted">(Optional)</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="endpoint" 
                               name="endpoint" 
                               value="{{ peer.endpoint or '' }}"
                               placeholder="e.g., example.com:51820, 192.168.1.100:12000">
                        <div class="form-text">The endpoint address and port where this peer can be reached</div>
                    </div>

                    <div class="mb-3">
                        <label for="persistent_keepalive" class="form-label">
                            <i class="fas fa-heartbeat me-1"></i>Persistent Keepalive <span class="text-muted">(Optional)</span>
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="persistent_keepalive" 
                                   name="persistent_keepalive" 
                                   value="{{ peer.persistent_keepalive or '' }}"
                                   min="0" 
                                   max="65535" 
                                   placeholder="25">
                            <span class="input-group-text">seconds</span>
                        </div>
                        <div class="form-text">Interval for keepalive packets (recommended: 25 seconds for NAT traversal)</div>
                    </div>

                    <!-- Firewall Rules Section -->
                    <div class="mb-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-shield-alt me-2"></i>Firewall Rules
                                    <small class="float-end">Optional Security Configuration</small>
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Template Selection -->
                                <div class="mb-3">
                                    <label for="firewall_template" class="form-label">
                                        <i class="fas fa-template me-1"></i>Security Template
                                    </label>
                                    <select class="form-select" id="firewall_template" name="firewall_template" onchange="applyFirewallTemplate()">
                                        <option value="">Select a template...</option>
                                        <option value="unrestricted">üîì Unrestricted Access (No Firewall)</option>
                                        <option value="internet_only">üåê Internet Only (No Peer Communication)</option>
                                        <option value="restricted">üîí Restricted Access (Custom Rules)</option>
                                        <option value="admin">üëë Administrator (Full Access)</option>
                                        <option value="guest">üë• Guest Access (Limited)</option>
                                    </select>
                                    <div class="form-text">Choose a predefined security template or create custom rules below</div>
                                </div>

                                <!-- Rules Container -->
                                <div id="firewall-rules-container">
                                    <!-- Dynamic firewall rules will be populated here -->
                                </div>

                                <!-- Add Rule Button -->
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addFirewallRule()">
                                        <i class="fas fa-plus me-1"></i>Add Custom Rule
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="previewIptablesRules()">
                                        <i class="fas fa-eye me-1"></i>Preview iptables
                                    </button>
                                </div>

                                <!-- Rules Summary -->
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-1"></i>Firewall Rules Summary</h6>
                                    <div id="rules-summary">
                                        <p class="mb-0 text-muted">No firewall rules configured - peer will have unrestricted access</p>
                                    </div>
                                </div>

                                <!-- Template Descriptions -->
                                <div class="accordion accordion-flush" id="templateHelp">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#templateDescriptions">
                                                <i class="fas fa-question-circle me-2"></i>Template Descriptions
                                            </button>
                                        </h2>
                                        <div id="templateDescriptions" class="accordion-collapse collapse" data-bs-parent="#templateHelp">
                                            <div class="accordion-body">
                                                <dl class="small">
                                                    <dt>üîì Unrestricted Access:</dt>
                                                    <dd>No firewall restrictions. Peer can access everything including other peers and internet.</dd>
                                                    
                                                    <dt>üåê Internet Only:</dt>
                                                    <dd>Peer can access internet but cannot communicate with other VPN peers.</dd>
                                                    
                                                    <dt>üîí Restricted Access:</dt>
                                                    <dd>Custom rules define what the peer can access. Good for specific use cases.</dd>
                                                    
                                                    <dt>üëë Administrator:</dt>
                                                    <dd>Full access to all networks, peers, and specific admin services.</dd>
                                                    
                                                    <dt>üë• Guest Access:</dt>
                                                    <dd>Limited internet access, no peer communication, restricted ports.</dd>
                                                </dl>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Note:</strong> The preshared key cannot be changed and will remain as: 
                        <code>{{ peer.preshared_key[:10] }}...</code>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('show_peer', peer_id=peer.id) }}" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save me-1"></i>Update Peer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Current Configuration</h5>
            </div>
            <div class="card-body">
                <dl class="small">
                    <dt>Peer ID:</dt>
                    <dd>{{ peer.id }}</dd>
                    
                    <dt>Created:</dt>
                    <dd>{{ peer.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                    
                    <dt>Last Updated:</dt>
                    <dd>{{ peer.updated_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                    
                    <dt>Preshared Key:</dt>
                    <dd>
                        <div class="d-flex align-items-center">
                            <code class="me-2">{{ peer.preshared_key[:20] }}...</code>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('{{ peer.preshared_key }}', this)" title="Copy preshared key">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <small class="text-muted">Auto-generated, cannot be changed</small>
                    </dd>
                </dl>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Important Notes</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-shield-alt me-1"></i>Security Considerations</h6>
                    <ul class="small mb-0">
                        <li>Changing the public key will require updating the client configuration</li>
                        <li>Changing allowed IPs may affect routing</li>
                        <li>The preshared key cannot be modified for security reasons</li>
                    </ul>
                </div>
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-sync-alt me-1"></i>After Update</h6>
                    <ul class="small mb-0">
                        <li>Server configuration (wg0.conf) will be automatically regenerated</li>
                        <li>Client configurations may need to be redistributed</li>
                        <li>Active connections using old settings will need to reconnect</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Validation Tips</h5>
            </div>
            <div class="card-body">
                <h6><i class="fas fa-check-circle me-1"></i>Field Requirements</h6>
                <ul class="small">
                    <li><strong>Name:</strong> Only alphanumeric, hyphens, underscores</li>
                    <li><strong>Public Key:</strong> Must be valid WireGuard key format (44 characters)</li>
                    <li><strong>Allowed IPs:</strong> Valid CIDR notation (e.g., 10.0.0.1/32)</li>
                    <li><strong>Endpoint:</strong> Format: hostname:port or ip:port</li>
                    <li><strong>Keepalive:</strong> Number between 0-65535 seconds</li>
                </ul>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="validateForm()">
                        <i class="fas fa-check me-1"></i>Test Validation
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm ms-2" onclick="showQRCode()">
                        <i class="fas fa-qrcode me-1"></i>Show QR Code
                    </button>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Change History</h5>
            </div>
            <div class="card-body">
                <p class="small text-muted">
                    Change history tracking is not yet implemented. Future versions will show:
                </p>
                <ul class="small text-muted">
                    <li>Who made changes and when</li>
                    <li>What fields were modified</li>
                    <li>Previous values for rollback</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- iptables Rules Modal -->
<div class="modal fade" id="iptablesModal" tabindex="-1" aria-labelledby="iptablesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="iptablesModalLabel">
                    <i class="fas fa-terminal me-2 text-success"></i>Generated iptables Rules for {{ peer.name }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Terminal Header -->
                <div class="bg-secondary p-2 d-flex justify-content-between align-items-center border-bottom border-dark">
                    <div class="d-flex align-items-center">
                        <span class="text-success me-2">‚óè</span>
                        <span class="text-warning me-2">‚óè</span>
                        <span class="text-danger me-2">‚óè</span>
                        <small class="text-muted ms-3">iptables-rules.sh</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" onclick="copyAllIptablesRules()" title="Copy all rules">
                            <i class="fas fa-copy me-1"></i>Copy All
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="downloadIptablesRules()" title="Download as script">
                            <i class="fas fa-download me-1"></i>Download
                        </button>
                    </div>
                </div>
                
                <!-- Terminal Content -->
                <div class="console-container">
                    <div id="iptablesContent" class="console-content">
                        <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                            <div class="text-muted">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <p>Loading iptables rules...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary bg-dark">
                <div class="flex-grow-1">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Click on any line to copy that specific rule
                    </small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrCodeModalLabel">
                    <i class="fas fa-qrcode me-2"></i>QR Code for {{ peer.name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrCodeContainer">
                    <div class="d-flex justify-content-center align-items-center" style="height: 300px;">
                        <div class="text-muted">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
                <p class="mt-3 small text-muted">
                    Scan this QR code with the WireGuard mobile app to quickly import the configuration.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadQRCode()" disabled>
                    <i class="fas fa-download me-1"></i>Download QR Code
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dynamic IP field management
let ipFieldCounter = 0;

function addIpField(value = '', description = '') {
    const container = document.getElementById('allowed-ips-container');
    const fieldId = `ip-field-${ipFieldCounter++}`;
    
    const fieldGroup = document.createElement('div');
    fieldGroup.className = 'ip-input-group mb-2';
    fieldGroup.id = fieldId;
    
    fieldGroup.innerHTML = `
        <div class="row g-2">
            <div class="col-8">
                <input type="text" 
                       class="form-control ip-network-input" 
                       name="allowed_ip_networks[]" 
                       placeholder="e.g., 192.168.1.0/24, 172.16.0.0/16"
                       value="${value}"
                       onblur="validateIpField(this)">
                <div class="invalid-feedback"></div>
            </div>
            <div class="col-3">
                <input type="text" 
                       class="form-control" 
                       name="allowed_ip_descriptions[]" 
                       placeholder="Description (optional)"
                       value="${description}">
            </div>
            <div class="col-1">
                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeIpField('${fieldId}')" title="Remove">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(fieldGroup);
}

function removeIpField(fieldId) {
    const field = document.getElementById(fieldId);
    if (field) {
        field.remove();
    }
}

function validateIpField(input) {
    const value = input.value.trim();
    const feedback = input.parentNode.querySelector('.invalid-feedback');
    
    // Clear previous validation
    input.classList.remove('is-valid', 'is-invalid');
    feedback.textContent = '';
    
    if (!value) {
        return; // Empty is allowed
    }
    
    // Basic CIDR validation
    const cidrPattern = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\/\d{1,2}$/;
    const ipPattern = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;
    
    if (!cidrPattern.test(value) && !ipPattern.test(value)) {
        input.classList.add('is-invalid');
        feedback.textContent = 'Use CIDR notation (e.g., 192.168.1.0/24) or single IP';
        return false;
    }
    
    // Validate IP parts
    const parts = value.split('/')[0].split('.');
    for (let part of parts) {
        const num = parseInt(part);
        if (num < 0 || num > 255) {
            input.classList.add('is-invalid');
            feedback.textContent = 'Invalid IP address';
            return false;
        }
    }
    
    // Validate CIDR prefix if present
    if (value.includes('/')) {
        const prefix = parseInt(value.split('/')[1]);
        if (prefix < 0 || prefix > 32) {
            input.classList.add('is-invalid');
            feedback.textContent = 'CIDR prefix must be between 0 and 32';
            return false;
        }
    }
    
    input.classList.add('is-valid');
    return true;
}

// Form validation
function validateForm() {
    const name = document.getElementById('name').value;
    const publicKey = document.getElementById('public_key').value;
    const endpoint = document.getElementById('endpoint').value;
    const keepalive = document.getElementById('persistent_keepalive').value;
    
    let errors = [];
    
    // Validate name
    if (!name.match(/^[a-zA-Z0-9_-]+$/)) {
        errors.push('Name can only contain letters, numbers, hyphens and underscores');
    }
    
    // Validate public key
    if (publicKey.length !== 44 || !publicKey.match(/^[A-Za-z0-9+/]{43}=$/)) {
        errors.push('Invalid WireGuard public key format');
    }
    
    // Validate endpoint (if provided)
    if (endpoint && !endpoint.match(/^[a-zA-Z0-9.-]+:\d+$/)) {
        errors.push('Endpoint should be in format hostname:port');
    }
    
    // Validate keepalive (if provided)
    if (keepalive && (isNaN(keepalive) || keepalive < 0 || keepalive > 65535)) {
        errors.push('Persistent keepalive should be a number between 0 and 65535');
    }
    
    // Validate IP fields
    const ipInputs = document.querySelectorAll('.ip-network-input');
    ipInputs.forEach(input => {
        if (input.value.trim() && !validateIpField(input)) {
            errors.push('Fix IP validation errors');
        }
    });
    
    if (errors.length === 0) {
        alert('‚úÖ All fields look valid!');
    } else {
        alert('‚ùå Validation errors:\n\n' + errors.join('\n'));
    }
}

// Real-time validation feedback
document.addEventListener('DOMContentLoaded', function() {
    const inputs = ['name', 'public_key', 'endpoint', 'persistent_keepalive'];
    
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('blur', function() {
                validateField(this);
            });
        }
    });

    // Load existing allowed IPs
    const existingIPs = [
        {% for allowed_ip in peer.allowed_ip_ranges %}
        { network: '{{ allowed_ip.ip_network }}', description: '{{ allowed_ip.description or "" }}' }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    if (existingIPs.length === 0) {
        // Add one empty field if no existing IPs
        addIpField();
    } else {
        // Load existing IPs
        existingIPs.forEach(ip => {
            addIpField(ip.network, ip.description);
        });
    }
});

function validateField(field) {
    const fieldName = field.id;
    const value = field.value.trim();
    let isValid = true;
    let message = '';
    
    switch(fieldName) {
        case 'name':
            isValid = value.match(/^[a-zA-Z0-9_-]+$/);
            message = isValid ? '' : 'Only letters, numbers, hyphens and underscores allowed';
            break;
        case 'public_key':
            isValid = value.length === 44 && value.match(/^[A-Za-z0-9+/]{43}=$/);
            message = isValid ? '' : 'Invalid WireGuard public key format';
            break;
        case 'endpoint':
            if (value) {
                isValid = value.match(/^[a-zA-Z0-9.-]+:\d+$/);
                message = isValid ? '' : 'Use format hostname:port';
            }
            break;
        case 'persistent_keepalive':
            if (value) {
                const num = parseInt(value);
                isValid = !isNaN(num) && num >= 0 && num <= 65535;
                message = isValid ? '' : 'Must be between 0 and 65535';
            }
            break;
    }
    
    // Update field styling
    field.classList.remove('is-valid', 'is-invalid');
    const feedback = field.parentNode.querySelector('.invalid-feedback');
    if (feedback) feedback.remove();
    
    if (value && !isValid) {
        field.classList.add('is-invalid');
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'invalid-feedback';
        feedbackDiv.textContent = message;
        field.parentNode.appendChild(feedbackDiv);
    } else if (value) {
        field.classList.add('is-valid');
    }
}

// Form submission with confirmation and validation
document.querySelector('form').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value;
    
    // Validate all IP fields
    const ipInputs = document.querySelectorAll('.ip-network-input');
    let hasErrors = false;
    
    ipInputs.forEach(input => {
        if (input.value.trim() && !validateIpField(input)) {
            hasErrors = true;
        }
    });
    
    if (hasErrors) {
        e.preventDefault();
        alert('Please fix the IP validation errors before submitting.');
        return;
    }
    
    if (!confirm(`Are you sure you want to update peer "${name}"?\n\nThis will regenerate the server configuration and may affect active connections.`)) {
        e.preventDefault();
    }
});

// Firewall Rules Management
let firewallRuleCounter = 0;

const firewallTemplates = {
    unrestricted: {
        name: 'Unrestricted Access',
        rules: []
    },
    internet_only: {
        name: 'Internet Only',
        rules: [
            { name: 'Allow Internet', type: 'internet', action: 'ALLOW', destination: '0.0.0.0/0', protocol: 'any', port: 'any' },
            { name: 'Deny Peer Communication', type: 'peer_comm', action: 'DENY', destination: '10.0.0.0/24', protocol: 'any', port: 'any' }
        ]
    },
    restricted: {
        name: 'Restricted Access',
        rules: [
            { name: 'Allow DNS', type: 'port', action: 'ALLOW', destination: 'any', protocol: 'udp', port: '53' },
            { name: 'Allow HTTP/HTTPS', type: 'port', action: 'ALLOW', destination: 'any', protocol: 'tcp', port: '80,443' }
        ]
    },
    admin: {
        name: 'Administrator',
        rules: [
            { name: 'Allow All', type: 'custom', action: 'ALLOW', destination: '0.0.0.0/0', protocol: 'any', port: 'any' }
        ]
    },
    guest: {
        name: 'Guest Access',
        rules: [
            { name: 'Allow DNS', type: 'port', action: 'ALLOW', destination: 'any', protocol: 'udp', port: '53' },
            { name: 'Allow HTTP/HTTPS', type: 'port', action: 'ALLOW', destination: 'any', protocol: 'tcp', port: '80,443' },
            { name: 'Deny Peer Communication', type: 'peer_comm', action: 'DENY', destination: '10.0.0.0/24', protocol: 'any', port: 'any' },
            { name: 'Deny SSH', type: 'port', action: 'DENY', destination: 'any', protocol: 'tcp', port: '22' }
        ]
    }
};

function applyFirewallTemplate() {
    const templateSelect = document.getElementById('firewall_template');
    const templateKey = templateSelect.value;
    
    if (!templateKey) return;
    
    const template = firewallTemplates[templateKey];
    if (!template) return;
    
    // Clear existing rules
    document.getElementById('firewall-rules-container').innerHTML = '';
    firewallRuleCounter = 0;
    
    // Add template rules
    template.rules.forEach(rule => {
        addFirewallRule(rule);
    });
    
    updateRulesSummary();
}

function addFirewallRule(ruleData = null) {
    const container = document.getElementById('firewall-rules-container');
    const ruleId = `firewall-rule-${firewallRuleCounter++}`;
    
    const rule = ruleData || {
        name: '',
        type: 'custom',
        action: 'ALLOW',
        destination: '',
        protocol: 'any',
        port: 'any'
    };
    
    const ruleElement = document.createElement('div');
    ruleElement.className = 'card mb-2';
    ruleElement.id = ruleId;
    
    ruleElement.innerHTML = `
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label small">Rule Name</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="firewall_rule_names[]" 
                           value="${rule.name}" 
                           placeholder="e.g., Allow DNS">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Action</label>
                    <select class="form-select form-select-sm" name="firewall_rule_actions[]">
                        <option value="ALLOW" ${rule.action === 'ALLOW' ? 'selected' : ''}>üü¢ Allow</option>
                        <option value="DENY" ${rule.action === 'DENY' ? 'selected' : ''}>üî¥ Deny</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Type</label>
                    <select class="form-select form-select-sm" name="firewall_rule_types[]" onchange="updateRuleFields('${ruleId}')">
                        <option value="custom" ${rule.type === 'custom' ? 'selected' : ''}>Custom</option>
                        <option value="internet" ${rule.type === 'internet' ? 'selected' : ''}>Internet</option>
                        <option value="peer_comm" ${rule.type === 'peer_comm' ? 'selected' : ''}>Peer Comm</option>
                        <option value="port" ${rule.type === 'port' ? 'selected' : ''}>Port Filter</option>
                        <option value="subnet" ${rule.type === 'subnet' ? 'selected' : ''}>Subnet</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Destination</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="firewall_rule_destinations[]" 
                           value="${rule.destination}" 
                           placeholder="IP/CIDR or 'any'">
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Protocol</label>
                    <select class="form-select form-select-sm" name="firewall_rule_protocols[]">
                        <option value="any" ${rule.protocol === 'any' ? 'selected' : ''}>Any</option>
                        <option value="tcp" ${rule.protocol === 'tcp' ? 'selected' : ''}>TCP</option>
                        <option value="udp" ${rule.protocol === 'udp' ? 'selected' : ''}>UDP</option>
                        <option value="icmp" ${rule.protocol === 'icmp' ? 'selected' : ''}>ICMP</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Port</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="firewall_rule_ports[]" 
                           value="${rule.port}" 
                           placeholder="any">
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Action</label>
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                            onclick="removeFirewallRule('${ruleId}')" title="Remove Rule">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(ruleElement);
    updateRulesSummary();
}

function removeFirewallRule(ruleId) {
    const rule = document.getElementById(ruleId);
    if (rule) {
        rule.remove();
        updateRulesSummary();
    }
}

function updateRuleFields(ruleId) {
    const ruleElement = document.getElementById(ruleId);
    const typeSelect = ruleElement.querySelector('select[name="firewall_rule_types[]"]');
    const destinationInput = ruleElement.querySelector('input[name="firewall_rule_destinations[]"]');
    
    const type = typeSelect.value;
    
    switch(type) {
        case 'internet':
            destinationInput.value = '0.0.0.0/0';
            destinationInput.placeholder = 'Internet (0.0.0.0/0)';
            break;
        case 'peer_comm':
            destinationInput.value = '10.0.0.0/24';
            destinationInput.placeholder = 'VPN Subnet';
            break;
        case 'subnet':
            destinationInput.value = '';
            destinationInput.placeholder = 'e.g., 192.168.1.0/24';
            break;
        default:
            destinationInput.placeholder = 'IP/CIDR or "any"';
    }
    
    updateRulesSummary();
}

function updateRulesSummary() {
    const rules = document.querySelectorAll('#firewall-rules-container .card');
    const summaryDiv = document.getElementById('rules-summary');
    
    if (rules.length === 0) {
        summaryDiv.innerHTML = '<p class="mb-0 text-muted">No firewall rules configured - peer will have unrestricted access</p>';
        return;
    }
    
    let allowRules = 0;
    let denyRules = 0;
    
    rules.forEach(rule => {
        const action = rule.querySelector('select[name="firewall_rule_actions[]"]').value;
        if (action === 'ALLOW') allowRules++;
        else denyRules++;
    });
    
    summaryDiv.innerHTML = `
        <div class="row">
            <div class="col-6">
                <span class="badge bg-success">${allowRules} Allow Rules</span>
            </div>
            <div class="col-6">
                <span class="badge bg-danger">${denyRules} Deny Rules</span>
            </div>
        </div>
        <small class="text-muted">Total: ${rules.length} firewall rules configured</small>
    `;
}

async function previewIptablesRules() {
    const modal = new bootstrap.Modal(document.getElementById('iptablesModal'));
    const content = document.getElementById('iptablesContent');
    
    // Show loading state
    content.innerHTML = `
        <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
            <div class="text-muted">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p>Generating iptables rules...</p>
            </div>
        </div>
    `;
    
    modal.show();
    
    try {
        const response = await fetch(`/api/v1/firewall/rules/generate?peer_id={{ peer.id }}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            displayIptablesRules(data.rules);
            // Store rules for copy/download functions
            window.currentIptablesRules = data.rules;
        } else {
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error generating rules: ${data.message}
                </div>
            `;
        }
    } catch (error) {
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error previewing rules: ${error.message}
            </div>
        `;
    }
}

// Load existing firewall rules when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load existing firewall rules for this peer
    const existingRules = [
        {% for rule in peer.firewall_rules %}
        {
            name: '{{ rule.name }}',
            type: '{{ rule.rule_type }}',
            action: '{{ rule.action }}',
            destination: '{{ rule.destination or "" }}',
            protocol: '{{ rule.protocol }}',
            port: '{{ rule.port_range }}'
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Load existing rules or start with unrestricted template
    if (existingRules.length === 0) {
        document.getElementById('firewall_template').value = 'unrestricted';
    } else {
        existingRules.forEach(rule => {
            addFirewallRule(rule);
        });
    }
    
    updateRulesSummary();
});

// Highlight changes
document.addEventListener('DOMContentLoaded', function() {
    const originalValues = {
        name: '{{ peer.name }}',
        public_key: '{{ peer.public_key }}',
        endpoint: '{{ peer.endpoint or "" }}',
        persistent_keepalive: '{{ peer.persistent_keepalive or "" }}'
    };
    
    Object.keys(originalValues).forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (field) {
            field.addEventListener('input', function() {
                const isChanged = this.value !== originalValues[fieldName];
                this.style.backgroundColor = isChanged ? 'rgba(255, 193, 7, 0.1)' : '';
            });
        }
    });
});

// QR Code Functions
function showQRCode() {
    const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
    const qrContainer = document.getElementById('qrCodeContainer');
    const downloadBtn = document.querySelector('button[onclick="downloadQRCode()"]');
    
    // Show loading state
    qrContainer.innerHTML = `
        <div class="d-flex justify-content-center align-items-center" style="height: 300px;">
            <div class="text-muted">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p>Generating QR Code...</p>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Fetch QR code from backend
    fetch(`/peers/{{ peer.id }}/qrcode`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                qrContainer.innerHTML = `
                    <img src="${data.qr_code}" alt="QR Code for {{ peer.name }}" class="img-fluid" style="max-width: 300px;">
                `;
                downloadBtn.disabled = false;
                
                // Store QR code data for download
                window.currentQRCode = data.qr_code;
                window.currentPeerName = data.peer_name;
            } else {
                qrContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error generating QR code: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            qrContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to generate QR code. Please try again.
                </div>
            `;
        });
}

function downloadQRCode() {
    if (!window.currentQRCode || !window.currentPeerName) {
        alert('No QR code available to download. Please generate QR code first.');
        return;
    }
    
    try {
        // Create download link
        const link = document.createElement('a');
        link.href = window.currentQRCode;
        link.download = `${window.currentPeerName}_qrcode.png`;
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error('Download error:', error);
        alert('Error downloading QR code. Please try again.');
    }
}

// iptables Console Functions
function displayIptablesRules(rules) {
    const content = document.getElementById('iptablesContent');
    
    let html = '<div class="terminal-prompt">root@wireguard-server:~# </div>';
    html += '<span class="terminal-path">./generate-iptables.sh</span><br><br>';
    
    rules.forEach((rule, index) => {
        if (rule.startsWith('#')) {
            html += `<div class="console-line comment" onclick="copyIptableLine(this, ${index})">${rule}</div>`;
        } else if (rule.trim() === '') {
            html += '<br>';
        } else {
            html += `<div class="console-line rule-command" onclick="copyIptableLine(this, ${index})">${rule}</div>`;
        }
    });
    
    html += '<br><div class="terminal-prompt">root@wireguard-server:~# </div>';
    html += '<span class="text-success">‚úì iptables rules generated successfully</span>';
    
    content.innerHTML = html;
}

function copyIptableLine(element, index) {
    const rule = window.currentIptablesRules[index];
    if (rule && rule.trim() !== '' && !rule.startsWith('#')) {
        copyToClipboard(rule, element);
        
        // Visual feedback
        element.classList.add('copied');
        setTimeout(() => {
            element.classList.remove('copied');
        }, 500);
        
        // Show toast notification
        showToast(`Copied: ${rule.substring(0, 50)}${rule.length > 50 ? '...' : ''}`, 'success');
    }
}

function copyAllIptablesRules() {
    if (!window.currentIptablesRules || window.currentIptablesRules.length === 0) {
        showToast('No rules to copy', 'warning');
        return;
    }
    
    const scriptContent = generateIptablesScript(window.currentIptablesRules);
    
    navigator.clipboard.writeText(scriptContent).then(() => {
        showToast(`Copied all ${window.currentIptablesRules.length} iptables rules to clipboard`, 'success');
    }).catch(err => {
        console.error('Failed to copy rules:', err);
        showToast('Failed to copy rules to clipboard', 'error');
    });
}

function downloadIptablesRules() {
    if (!window.currentIptablesRules || window.currentIptablesRules.length === 0) {
        showToast('No rules to download', 'warning');
        return;
    }
    
    const scriptContent = generateIptablesScript(window.currentIptablesRules);
    const peerName = '{{ peer.name }}';
    
    const blob = new Blob([scriptContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${peerName}_iptables_rules.sh`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
    
    showToast(`Downloaded iptables script: ${peerName}_iptables_rules.sh`, 'success');
}

function generateIptablesScript(rules) {
    const peerName = '{{ peer.name }}';
    const timestamp = new Date().toISOString();
    
    let script = `#!/bin/bash
# iptables rules for WireGuard peer: ${peerName}
# Generated on: ${timestamp}
# 
# Usage: sudo ./$(basename "$0")
# 
# This script applies iptables rules for the specific peer.
# Make sure to review the rules before applying them.

set -e  # Exit on error

echo "Applying iptables rules for peer: ${peerName}"
echo "Generated on: ${timestamp}"
echo ""

`;

    rules.forEach(rule => {
        if (rule.startsWith('#')) {
            script += `${rule}\n`;
        } else if (rule.trim() !== '') {
            script += `echo "Executing: ${rule}"\n`;
            script += `${rule}\n`;
        }
        script += '\n';
    });

    script += `
echo ""
echo "‚úì All iptables rules applied successfully"
echo "Current FORWARD chain rules:"
iptables -L FORWARD -n --line-numbers
`;

    return script;
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}
</script>
{% endblock %}

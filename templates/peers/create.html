{% extends "base.html" %}

{% block title %}Add New Peer - WireGuard Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-plus me-2"></i>Add New Peer</h1>
    <a href="{{ url_for('list_peers') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to Peers
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user-plus me-2"></i>Peer Configuration</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('create_peer') }}" method="post">
                    <div class="mb-3">
                        <label for="name" class="form-label">
                            <i class="fas fa-tag me-1"></i>Peer Name <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="name" 
                               name="name" 
                               required 
                               placeholder="e.g., john-laptop, alice-phone"
                               pattern="[a-zA-Z0-9_-]+"
                               title="Only letters, numbers, hyphens and underscores allowed">
                        <div class="form-text">A unique name to identify this peer (alphanumeric, -, _ only)</div>
                    </div>

                    <div class="mb-3">
                        <label for="public_key" class="form-label">
                            <i class="fas fa-key me-1"></i>Public Key <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control font-monospace" 
                                   id="public_key" 
                                   name="public_key" 
                                   required 
                                   placeholder="e.g., LSsHed2xa2wxNymEit4kiOpj3kuaDuf0q0VohjRkAXQ=">
                            <button type="button" class="btn btn-outline-secondary" onclick="generateKeyPair()" title="Generate key pair">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                        <div class="form-text">The WireGuard public key for this peer</div>
                    </div>

                    <div class="mb-3">
                        <label for="assigned_ip" class="form-label">
                            <i class="fas fa-network-wired me-1"></i>Assigned IP Address
                        </label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control font-monospace"
                                   id="assigned_ip" 
                                   value="{% if next_available_ip %}{{ next_available_ip }}{% else %}Loading...{% endif %}"
                                   readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="refreshIP()" title="Refresh IP">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="form-text">This IP will be automatically assigned to the peer (cannot be changed)</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-plus-circle me-1"></i>Additional Allowed IPs <span class="text-muted">(Optional)</span>
                        </label>
                        <div id="allowed-ips-container">
                            <!-- Dynamic IP input fields will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addIpField()">
                            <i class="fas fa-plus me-1"></i>Add IP Range
                        </button>
                        <div class="form-text mt-2">
                            IP ranges this peer should be allowed to access (CIDR notation). 
                            <br><strong>Note:</strong> IPs must be outside the VPN subnet ({{ config.VPN_SUBNET if config else '10.0.0.0/24' }}) and cannot overlap with other peers.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="endpoint" class="form-label">
                            <i class="fas fa-globe me-1"></i>Endpoint <span class="text-muted">(Optional)</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="endpoint" 
                               name="endpoint" 
                               placeholder="e.g., example.com:51820, 192.168.1.100:12000">
                        <div class="form-text">The endpoint address and port where this peer can be reached</div>
                    </div>

                    <div class="mb-3">
                        <label for="persistent_keepalive" class="form-label">
                            <i class="fas fa-heartbeat me-1"></i>Persistent Keepalive <span class="text-muted">(Optional)</span>
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="persistent_keepalive" 
                                   name="persistent_keepalive" 
                                   min="0" 
                                   max="65535" 
                                   placeholder="25">
                            <span class="input-group-text">seconds</span>
                        </div>
                        <div class="form-text">Interval for keepalive packets (recommended: 25 seconds for NAT traversal)</div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('list_peers') }}" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Create Peer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Instructions</h5>
            </div>
            <div class="card-body">
                <h6><i class="fas fa-terminal me-1"></i>Generating Keys</h6>
                <p class="small">Run these commands to generate a WireGuard key pair:</p>
                <div class="bg-dark text-light p-2 rounded mb-3">
                    <code class="d-block mb-1">wg genkey | tee privatekey | wg pubkey > publickey</code>
                    <code class="d-block">cat publickey</code>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="copyToClipboard('wg genkey | tee privatekey | wg pubkey > publickey\\ncat publickey', this)">
                    <i class="fas fa-copy me-1"></i>Copy Commands
                </button>

                <h6><i class="fas fa-lightbulb me-1"></i>Field Tips</h6>
                <ul class="small">
                    <li><strong>Name:</strong> Use descriptive names like "john-laptop" or "server-01"</li>
                    <li><strong>Allowed IPs:</strong> Use /32 for single IPs, /24 for subnets</li>
                    <li><strong>Endpoint:</strong> Only needed for peers that connect to this server</li>
                    <li><strong>Keepalive:</strong> Use 25 seconds if behind NAT/firewall</li>
                </ul>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Note:</strong> A preshared key will be automatically generated for enhanced security.
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Key Generator</h5>
            </div>
            <div class="card-body">
                <p class="small">Generate a new WireGuard key pair:</p>
                <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="generateKeyPair()">
                    <i class="fas fa-magic me-1"></i>Generate Key Pair
                </button>
                <div id="generatedKeys" class="mt-3 d-none">
                    <div class="form-group mb-2">
                        <label class="form-label small">Private Key:</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control font-monospace" id="generatedPrivateKey" readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard(document.getElementById('generatedPrivateKey').value, this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label small">Public Key:</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control font-monospace" id="generatedPublicKey" readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard(document.getElementById('generatedPublicKey').value, this); document.getElementById('public_key').value = document.getElementById('generatedPublicKey').value;">
                                <i class="fas fa-copy"></i> Use
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Refresh IP address
function refreshIP() {
    const ipInput = document.getElementById('assigned_ip');
    const refreshBtn = ipInput.nextElementSibling.querySelector('i');
    
    // Show loading state
    ipInput.value = 'Loading...';
    refreshBtn.classList.add('fa-spin');
    
    // Fetch next available IP
    fetch('/api/v1/next-ip')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                ipInput.value = data.ip;
            } else {
                ipInput.value = 'Error loading IP';
                console.error('Error:', data.message);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            ipInput.value = 'Error loading IP';
        })
        .finally(() => {
            refreshBtn.classList.remove('fa-spin');
        });
}

// Load IP on page load if not already set
document.addEventListener('DOMContentLoaded', function() {
    const ipInput = document.getElementById('assigned_ip');
    if (ipInput.value === 'Loading...' || !ipInput.value) {
        refreshIP();
    }
});

// Mock key generation - in a real implementation, this would call a backend service
function generateKeyPair() {
    // This is a simplified mock - real implementation would generate actual WireGuard keys
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
    let privateKey = '';
    let publicKey = '';
    
    // Generate 44-character base64 strings (simplified mock)
    for (let i = 0; i < 43; i++) {
        privateKey += chars.charAt(Math.floor(Math.random() * chars.length));
        publicKey += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    privateKey += '=';
    publicKey += '=';
    
    document.getElementById('generatedPrivateKey').value = privateKey;
    document.getElementById('generatedPublicKey').value = publicKey;
    document.getElementById('generatedKeys').classList.remove('d-none');
    
    // Show alert
    const alert = document.createElement('div');
    alert.className = 'alert alert-warning alert-dismissible fade show mt-2';
    alert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-1"></i>
        <strong>Mock Keys Generated!</strong> In production, use real WireGuard commands to generate secure keys.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.getElementById('generatedKeys').appendChild(alert);
}

// Dynamic IP field management
let ipFieldCounter = 0;

function addIpField(value = '', description = '') {
    const container = document.getElementById('allowed-ips-container');
    const fieldId = `ip-field-${ipFieldCounter++}`;
    
    const fieldGroup = document.createElement('div');
    fieldGroup.className = 'ip-input-group mb-2';
    fieldGroup.id = fieldId;
    
    fieldGroup.innerHTML = `
        <div class="row g-2">
            <div class="col-8">
                <input type="text" 
                       class="form-control ip-network-input" 
                       name="allowed_ip_networks[]" 
                       placeholder="e.g., 192.168.1.0/24, 172.16.0.0/16"
                       value="${value}"
                       onblur="validateIpField(this)">
                <div class="invalid-feedback"></div>
            </div>
            <div class="col-3">
                <input type="text" 
                       class="form-control" 
                       name="allowed_ip_descriptions[]" 
                       placeholder="Description (optional)"
                       value="${description}">
            </div>
            <div class="col-1">
                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeIpField('${fieldId}')" title="Remove">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(fieldGroup);
}

function removeIpField(fieldId) {
    const field = document.getElementById(fieldId);
    if (field) {
        field.remove();
    }
}

function validateIpField(input) {
    const value = input.value.trim();
    const feedback = input.parentNode.querySelector('.invalid-feedback');
    
    // Clear previous validation
    input.classList.remove('is-valid', 'is-invalid');
    feedback.textContent = '';
    
    if (!value) {
        return; // Empty is allowed
    }
    
    // Basic CIDR validation
    const cidrPattern = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\/\d{1,2}$/;
    const ipPattern = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;
    
    if (!cidrPattern.test(value) && !ipPattern.test(value)) {
        input.classList.add('is-invalid');
        feedback.textContent = 'Use CIDR notation (e.g., 192.168.1.0/24) or single IP';
        return false;
    }
    
    // Validate IP parts
    const parts = value.split('/')[0].split('.');
    for (let part of parts) {
        const num = parseInt(part);
        if (num < 0 || num > 255) {
            input.classList.add('is-invalid');
            feedback.textContent = 'Invalid IP address';
            return false;
        }
    }
    
    // Validate CIDR prefix if present
    if (value.includes('/')) {
        const prefix = parseInt(value.split('/')[1]);
        if (prefix < 0 || prefix > 32) {
            input.classList.add('is-invalid');
            feedback.textContent = 'CIDR prefix must be between 0 and 32';
            return false;
        }
    }
    
    // Check for VPN subnet overlap (basic check)
    const vpnSubnet = '{{ config.VPN_SUBNET if config else "10.0.0.0/24" }}';
    if (value.startsWith('10.0.0.') && vpnSubnet.startsWith('10.0.0.')) {
        input.classList.add('is-invalid');
        feedback.textContent = 'IP cannot be in VPN subnet (' + vpnSubnet + ')';
        return false;
    }
    
    input.classList.add('is-valid');
    return true;
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value;
    const publicKey = document.getElementById('public_key').value;
    
    if (!name.match(/^[a-zA-Z0-9_-]+$/)) {
        e.preventDefault();
        alert('Name can only contain letters, numbers, hyphens and underscores.');
        return;
    }
    
    if (publicKey.length !== 44 || !publicKey.match(/^[A-Za-z0-9+/]{43}=$/)) {
        e.preventDefault();
        alert('Invalid WireGuard public key format. It should be 44 characters ending with =');
        return;
    }
    
    // Validate all IP fields
    const ipInputs = document.querySelectorAll('.ip-network-input');
    let hasErrors = false;
    
    ipInputs.forEach(input => {
        if (input.value.trim() && !validateIpField(input)) {
            hasErrors = true;
        }
    });
    
    if (hasErrors) {
        e.preventDefault();
        alert('Please fix the IP validation errors before submitting.');
        return;
    }
});
</script>
{% endblock %}

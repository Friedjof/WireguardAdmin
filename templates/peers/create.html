{% extends "base.html" %}

{% block title %}Add New Peer - WireGuard Manager{% endblock %}

{% block head %}
<style>
.console-container {
    background: #1a1a1a;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    max-height: 500px;
    overflow-y: auto;
}

.console-content {
    padding: 20px;
    color: #00ff00;
    background: #000;
    border: none;
    min-height: 400px;
}

.console-line {
    display: block;
    padding: 2px 8px;
    margin: 1px 0;
    border-radius: 3px;
    cursor: pointer;
    transition: background-color 0.2s;
    white-space: pre-wrap;
    word-break: break-all;
}

.console-line:hover {
    background-color: rgba(0, 255, 0, 0.1);
}

.console-line.comment {
    color: #888;
    font-style: italic;
}

.console-line.command {
    color: #00ff00;
}

.console-line.rule-command {
    color: #00ddff;
}

.console-line.copied {
    background-color: rgba(0, 255, 0, 0.3) !important;
    animation: pulse 0.5s;
}

@keyframes pulse {
    0% { background-color: rgba(0, 255, 0, 0.3); }
    50% { background-color: rgba(0, 255, 0, 0.6); }
    100% { background-color: rgba(0, 255, 0, 0.3); }
}

.console-container::-webkit-scrollbar {
    width: 8px;
}

.console-container::-webkit-scrollbar-track {
    background: #1a1a1a;
}

.console-container::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}

.console-container::-webkit-scrollbar-thumb:hover {
    background: #777;
}

.terminal-prompt {
    color: #ffaa00;
    font-weight: bold;
}

.terminal-path {
    color: #00aaff;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-plus me-2"></i>Add New Peer</h1>
    <a href="{{ url_for('list_peers') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to Peers
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user-plus me-2"></i>Peer Configuration</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('create_peer') }}" method="post">
                    <div class="mb-3">
                        <label for="name" class="form-label">
                            <i class="fas fa-tag me-1"></i>Peer Name <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="name" 
                               name="name" 
                               required 
                               placeholder="e.g., john-laptop, alice-phone"
                               pattern="[a-zA-Z0-9_-]+"
                               title="Only letters, numbers, hyphens and underscores allowed">
                        <div class="form-text">A unique name to identify this peer (alphanumeric, -, _ only)</div>
                    </div>

                    <div class="mb-3">
                        <label for="public_key" class="form-label">
                            <i class="fas fa-key me-1"></i>Public Key <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control font-monospace" 
                                   id="public_key" 
                                   name="public_key" 
                                   required 
                                   placeholder="e.g., LSsHed2xa2wxNymEit4kiOpj3kuaDuf0q0VohjRkAXQ=">
                            <button type="button" class="btn btn-outline-secondary" onclick="generateKeyPair()" title="Generate key pair">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                        <div class="form-text">The WireGuard public key for this peer</div>
                    </div>

                    <div class="mb-3">
                        <label for="assigned_ip" class="form-label">
                            <i class="fas fa-network-wired me-1"></i>Assigned IP Address
                        </label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control font-monospace"
                                   id="assigned_ip" 
                                   value="{% if next_available_ip %}{{ next_available_ip }}{% else %}Loading...{% endif %}"
                                   readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="refreshIP()" title="Refresh IP">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="form-text">This IP will be automatically assigned to the peer (cannot be changed)</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-plus-circle me-1"></i>Additional Allowed IPs <span class="text-muted">(Optional)</span>
                        </label>
                        <div id="allowed-ips-container">
                            <!-- Dynamic IP input fields will be added here -->
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addIpField()">
                            <i class="fas fa-plus me-1"></i>Add IP Range
                        </button>
                        <div class="form-text mt-2">
                            IP ranges this peer should be allowed to access (CIDR notation). 
                            <br><strong>Note:</strong> IPs must be outside the VPN subnet ({{ config.VPN_SUBNET if config else '10.0.0.0/24' }}) and cannot overlap with other peers.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="endpoint" class="form-label">
                            <i class="fas fa-globe me-1"></i>Endpoint <span class="text-muted">(Optional)</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="endpoint" 
                               name="endpoint" 
                               placeholder="e.g., example.com:51820, 192.168.1.100:12000">
                        <div class="form-text">The endpoint address and port where this peer can be reached</div>
                    </div>

                    <div class="mb-3">
                        <label for="persistent_keepalive" class="form-label">
                            <i class="fas fa-heartbeat me-1"></i>Persistent Keepalive <span class="text-muted">(Optional)</span>
                        </label>
                        <div class="input-group">
                            <input type="number" 
                                   class="form-control" 
                                   id="persistent_keepalive" 
                                   name="persistent_keepalive" 
                                   min="0" 
                                   max="65535" 
                                   placeholder="25">
                            <span class="input-group-text">seconds</span>
                        </div>
                        <div class="form-text">Interval for keepalive packets (recommended: 25 seconds for NAT traversal)</div>
                    </div>

                    <!-- Firewall Rules Section -->
                    <div class="mb-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-shield-alt me-2"></i>Firewall Rules
                                    <small class="float-end">Optional Security Configuration</small>
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Template Selection -->
                                <div class="mb-3">
                                    <label for="firewall_template" class="form-label">
                                        <i class="fas fa-template me-1"></i>Security Template
                                    </label>
                                    <select class="form-select" id="firewall_template" name="firewall_template" onchange="applyFirewallTemplate()">
                                        <option value="unrestricted" selected>üîì Unrestricted Access (No Firewall)</option>
                                        <option value="internet_only">üåê Internet Only (No Peer Communication)</option>
                                        <option value="restricted">üîí Restricted Access (Custom Rules)</option>
                                        <option value="admin">üëë Administrator (Full Access)</option>
                                        <option value="guest">üë• Guest Access (Limited)</option>
                                    </select>
                                    <div class="form-text">Choose a predefined security template or create custom rules below</div>
                                </div>

                                <!-- Rules Container -->
                                <div id="firewall-rules-container">
                                    <!-- Dynamic firewall rules will be populated here -->
                                </div>

                                <!-- Add Rule Button -->
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addFirewallRule()">
                                        <i class="fas fa-plus me-1"></i>Add Custom Rule
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="previewIptablesRules()">
                                        <i class="fas fa-eye me-1"></i>Preview iptables
                                    </button>
                                </div>

                                <!-- Rules Summary -->
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-1"></i>Firewall Rules Summary</h6>
                                    <div id="rules-summary">
                                        <p class="mb-0 text-muted">No firewall rules configured - peer will have unrestricted access</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('list_peers') }}" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Create Peer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Instructions</h5>
            </div>
            <div class="card-body">
                <h6><i class="fas fa-terminal me-1"></i>Generating Keys</h6>
                <p class="small">Run these commands to generate a WireGuard key pair:</p>
                <div class="bg-dark text-light p-2 rounded mb-3">
                    <code class="d-block mb-1">wg genkey | tee privatekey | wg pubkey > publickey</code>
                    <code class="d-block">cat publickey</code>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="copyToClipboard('wg genkey | tee privatekey | wg pubkey > publickey\\ncat publickey', this)">
                    <i class="fas fa-copy me-1"></i>Copy Commands
                </button>

                <h6><i class="fas fa-lightbulb me-1"></i>Field Tips</h6>
                <ul class="small">
                    <li><strong>Name:</strong> Use descriptive names like "john-laptop" or "server-01"</li>
                    <li><strong>Allowed IPs:</strong> Use /32 for single IPs, /24 for subnets</li>
                    <li><strong>Endpoint:</strong> Only needed for peers that connect to this server</li>
                    <li><strong>Keepalive:</strong> Use 25 seconds if behind NAT/firewall</li>
                </ul>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Note:</strong> A preshared key will be automatically generated for enhanced security.
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Key Generator</h5>
            </div>
            <div class="card-body">
                <p class="small">Generate a new WireGuard key pair:</p>
                <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="generateKeyPair()">
                    <i class="fas fa-magic me-1"></i>Generate Key Pair
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm w-100 mt-2" disabled title="QR code will be available after creating the peer">
                    <i class="fas fa-qrcode me-1"></i>QR Code (Available after creation)
                </button>
                <div id="generatedKeys" class="mt-3 d-none">
                    <div class="form-group mb-2">
                        <label class="form-label small">Private Key:</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control font-monospace" id="generatedPrivateKey" readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard(document.getElementById('generatedPrivateKey').value, this)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label small">Public Key:</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control font-monospace" id="generatedPublicKey" readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="copyToClipboard(document.getElementById('generatedPublicKey').value, this); document.getElementById('public_key').value = document.getElementById('generatedPublicKey').value;">
                                <i class="fas fa-copy"></i> Use
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- iptables Rules Modal -->
<div class="modal fade" id="iptablesModal" tabindex="-1" aria-labelledby="iptablesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="iptablesModalLabel">
                    <i class="fas fa-terminal me-2 text-success"></i>Preview iptables Rules
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Terminal Header -->
                <div class="bg-secondary p-2 d-flex justify-content-between align-items-center border-bottom border-dark">
                    <div class="d-flex align-items-center">
                        <span class="text-success me-2">‚óè</span>
                        <span class="text-warning me-2">‚óè</span>
                        <span class="text-danger me-2">‚óè</span>
                        <small class="text-muted ms-3">iptables-rules.sh</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm" onclick="copyAllIptablesRules()" title="Copy all rules">
                            <i class="fas fa-copy me-1"></i>Copy All
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="downloadIptablesRules()" title="Download as script">
                            <i class="fas fa-download me-1"></i>Download
                        </button>
                    </div>
                </div>
                
                <!-- Terminal Content -->
                <div class="console-container">
                    <div id="iptablesContent" class="console-content">
                        <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                            <div class="text-muted">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                <p>Loading iptables rules...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary bg-dark">
                <div class="flex-grow-1">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Click on any line to copy that specific rule
                    </small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Refresh IP address
function refreshIP() {
    const ipInput = document.getElementById('assigned_ip');
    const refreshBtn = ipInput.nextElementSibling.querySelector('i');
    
    // Show loading state
    ipInput.value = 'Loading...';
    refreshBtn.classList.add('fa-spin');
    
    // Fetch next available IP
    fetch('/api/v1/next-ip')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                ipInput.value = data.ip;
            } else {
                ipInput.value = 'Error loading IP';
                console.error('Error:', data.message);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            ipInput.value = 'Error loading IP';
        })
        .finally(() => {
            refreshBtn.classList.remove('fa-spin');
        });
}

// Load IP on page load if not already set
document.addEventListener('DOMContentLoaded', function() {
    const ipInput = document.getElementById('assigned_ip');
    if (ipInput.value === 'Loading...' || !ipInput.value) {
        refreshIP();
    }
});

// Mock key generation - in a real implementation, this would call a backend service
function generateKeyPair() {
    // This is a simplified mock - real implementation would generate actual WireGuard keys
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
    let privateKey = '';
    let publicKey = '';
    
    // Generate 44-character base64 strings (simplified mock)
    for (let i = 0; i < 43; i++) {
        privateKey += chars.charAt(Math.floor(Math.random() * chars.length));
        publicKey += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    privateKey += '=';
    publicKey += '=';
    
    document.getElementById('generatedPrivateKey').value = privateKey;
    document.getElementById('generatedPublicKey').value = publicKey;
    document.getElementById('generatedKeys').classList.remove('d-none');
    
    // Show alert
    const alert = document.createElement('div');
    alert.className = 'alert alert-warning alert-dismissible fade show mt-2';
    alert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-1"></i>
        <strong>Mock Keys Generated!</strong> In production, use real WireGuard commands to generate secure keys.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.getElementById('generatedKeys').appendChild(alert);
}

// Dynamic IP field management
let ipFieldCounter = 0;

function addIpField(value = '', description = '') {
    const container = document.getElementById('allowed-ips-container');
    const fieldId = `ip-field-${ipFieldCounter++}`;
    
    const fieldGroup = document.createElement('div');
    fieldGroup.className = 'ip-input-group mb-2';
    fieldGroup.id = fieldId;
    
    fieldGroup.innerHTML = `
        <div class="row g-2">
            <div class="col-8">
                <input type="text" 
                       class="form-control ip-network-input" 
                       name="allowed_ip_networks[]" 
                       placeholder="e.g., 192.168.1.0/24, 172.16.0.0/16"
                       value="${value}"
                       onblur="validateIpField(this)">
                <div class="invalid-feedback"></div>
            </div>
            <div class="col-3">
                <input type="text" 
                       class="form-control" 
                       name="allowed_ip_descriptions[]" 
                       placeholder="Description (optional)"
                       value="${description}">
            </div>
            <div class="col-1">
                <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeIpField('${fieldId}')" title="Remove">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(fieldGroup);
}

function removeIpField(fieldId) {
    const field = document.getElementById(fieldId);
    if (field) {
        field.remove();
    }
}

function validateIpField(input) {
    const value = input.value.trim();
    const feedback = input.parentNode.querySelector('.invalid-feedback');
    
    // Clear previous validation
    input.classList.remove('is-valid', 'is-invalid');
    feedback.textContent = '';
    
    if (!value) {
        return; // Empty is allowed
    }
    
    // Basic CIDR validation
    const cidrPattern = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\/\d{1,2}$/;
    const ipPattern = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;
    
    if (!cidrPattern.test(value) && !ipPattern.test(value)) {
        input.classList.add('is-invalid');
        feedback.textContent = 'Use CIDR notation (e.g., 192.168.1.0/24) or single IP';
        return false;
    }
    
    // Validate IP parts
    const parts = value.split('/')[0].split('.');
    for (let part of parts) {
        const num = parseInt(part);
        if (num < 0 || num > 255) {
            input.classList.add('is-invalid');
            feedback.textContent = 'Invalid IP address';
            return false;
        }
    }
    
    // Validate CIDR prefix if present
    if (value.includes('/')) {
        const prefix = parseInt(value.split('/')[1]);
        if (prefix < 0 || prefix > 32) {
            input.classList.add('is-invalid');
            feedback.textContent = 'CIDR prefix must be between 0 and 32';
            return false;
        }
    }
    
    // Check for VPN subnet overlap (basic check)
    const vpnSubnet = '{{ config.VPN_SUBNET if config else "10.0.0.0/24" }}';
    if (value.startsWith('10.0.0.') && vpnSubnet.startsWith('10.0.0.')) {
        input.classList.add('is-invalid');
        feedback.textContent = 'IP cannot be in VPN subnet (' + vpnSubnet + ')';
        return false;
    }
    
    input.classList.add('is-valid');
    return true;
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value;
    const publicKey = document.getElementById('public_key').value;
    
    if (!name.match(/^[a-zA-Z0-9_-]+$/)) {
        e.preventDefault();
        alert('Name can only contain letters, numbers, hyphens and underscores.');
        return;
    }
    
    if (publicKey.length !== 44 || !publicKey.match(/^[A-Za-z0-9+/]{43}=$/)) {
        e.preventDefault();
        alert('Invalid WireGuard public key format. It should be 44 characters ending with =');
        return;
    }
    
    // Validate all IP fields
    const ipInputs = document.querySelectorAll('.ip-network-input');
    let hasErrors = false;
    
    ipInputs.forEach(input => {
        if (input.value.trim() && !validateIpField(input)) {
            hasErrors = true;
        }
    });
    
    if (hasErrors) {
        e.preventDefault();
        alert('Please fix the IP validation errors before submitting.');
        return;
    }
});

// Firewall Rules Management (same as edit.html)
let firewallRuleCounter = 0;

const firewallTemplates = {
    unrestricted: {
        name: 'Unrestricted Access',
        rules: []
    },
    internet_only: {
        name: 'Internet Only',
        rules: [
            { name: 'Allow Internet', type: 'internet', action: 'ALLOW', destination: '0.0.0.0/0', protocol: 'any', port: 'any' },
            { name: 'Deny Peer Communication', type: 'peer_comm', action: 'DENY', destination: '10.0.0.0/24', protocol: 'any', port: 'any' }
        ]
    },
    restricted: {
        name: 'Restricted Access',
        rules: [
            { name: 'Allow DNS', type: 'port', action: 'ALLOW', destination: 'any', protocol: 'udp', port: '53' },
            { name: 'Allow HTTP/HTTPS', type: 'port', action: 'ALLOW', destination: 'any', protocol: 'tcp', port: '80,443' }
        ]
    },
    admin: {
        name: 'Administrator',
        rules: [
            { name: 'Allow All', type: 'custom', action: 'ALLOW', destination: '0.0.0.0/0', protocol: 'any', port: 'any' }
        ]
    },
    guest: {
        name: 'Guest Access',
        rules: [
            { name: 'Allow DNS', type: 'port', action: 'ALLOW', destination: 'any', protocol: 'udp', port: '53' },
            { name: 'Allow HTTP/HTTPS', type: 'port', action: 'ALLOW', destination: 'any', protocol: 'tcp', port: '80,443' },
            { name: 'Deny Peer Communication', type: 'peer_comm', action: 'DENY', destination: '10.0.0.0/24', protocol: 'any', port: 'any' },
            { name: 'Deny SSH', type: 'port', action: 'DENY', destination: 'any', protocol: 'tcp', port: '22' }
        ]
    }
};

function applyFirewallTemplate() {
    const templateSelect = document.getElementById('firewall_template');
    const templateKey = templateSelect.value;
    
    if (!templateKey) return;
    
    const template = firewallTemplates[templateKey];
    if (!template) return;
    
    // Clear existing rules
    document.getElementById('firewall-rules-container').innerHTML = '';
    firewallRuleCounter = 0;
    
    // Add template rules
    template.rules.forEach(rule => {
        addFirewallRule(rule);
    });
    
    updateRulesSummary();
}

function addFirewallRule(ruleData = null) {
    const container = document.getElementById('firewall-rules-container');
    const ruleId = `firewall-rule-${firewallRuleCounter++}`;
    
    const rule = ruleData || {
        name: '',
        type: 'custom',
        action: 'ALLOW',
        destination: '',
        protocol: 'any',
        port: 'any'
    };
    
    const ruleElement = document.createElement('div');
    ruleElement.className = 'card mb-2';
    ruleElement.id = ruleId;
    
    ruleElement.innerHTML = `
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label small">Rule Name</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="firewall_rule_names[]" 
                           value="${rule.name}" 
                           placeholder="e.g., Allow DNS">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Action</label>
                    <select class="form-select form-select-sm" name="firewall_rule_actions[]">
                        <option value="ALLOW" ${rule.action === 'ALLOW' ? 'selected' : ''}>üü¢ Allow</option>
                        <option value="DENY" ${rule.action === 'DENY' ? 'selected' : ''}>üî¥ Deny</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Type</label>
                    <select class="form-select form-select-sm" name="firewall_rule_types[]" onchange="updateRuleFields('${ruleId}')">
                        <option value="custom" ${rule.type === 'custom' ? 'selected' : ''}>Custom</option>
                        <option value="internet" ${rule.type === 'internet' ? 'selected' : ''}>Internet</option>
                        <option value="peer_comm" ${rule.type === 'peer_comm' ? 'selected' : ''}>Peer Comm</option>
                        <option value="port" ${rule.type === 'port' ? 'selected' : ''}>Port Filter</option>
                        <option value="subnet" ${rule.type === 'subnet' ? 'selected' : ''}>Subnet</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Destination</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="firewall_rule_destinations[]" 
                           value="${rule.destination}" 
                           placeholder="IP/CIDR or 'any'">
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Protocol</label>
                    <select class="form-select form-select-sm" name="firewall_rule_protocols[]">
                        <option value="any" ${rule.protocol === 'any' ? 'selected' : ''}>Any</option>
                        <option value="tcp" ${rule.protocol === 'tcp' ? 'selected' : ''}>TCP</option>
                        <option value="udp" ${rule.protocol === 'udp' ? 'selected' : ''}>UDP</option>
                        <option value="icmp" ${rule.protocol === 'icmp' ? 'selected' : ''}>ICMP</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Port</label>
                    <input type="text" class="form-control form-control-sm" 
                           name="firewall_rule_ports[]" 
                           value="${rule.port}" 
                           placeholder="any">
                </div>
                <div class="col-md-1">
                    <label class="form-label small">Action</label>
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" 
                            onclick="removeFirewallRule('${ruleId}')" title="Remove Rule">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(ruleElement);
    updateRulesSummary();
}

function removeFirewallRule(ruleId) {
    const rule = document.getElementById(ruleId);
    if (rule) {
        rule.remove();
        updateRulesSummary();
    }
}

function updateRuleFields(ruleId) {
    const ruleElement = document.getElementById(ruleId);
    const typeSelect = ruleElement.querySelector('select[name="firewall_rule_types[]"]');
    const destinationInput = ruleElement.querySelector('input[name="firewall_rule_destinations[]"]');
    
    const type = typeSelect.value;
    
    switch(type) {
        case 'internet':
            destinationInput.value = '0.0.0.0/0';
            destinationInput.placeholder = 'Internet (0.0.0.0/0)';
            break;
        case 'peer_comm':
            destinationInput.value = '10.0.0.0/24';
            destinationInput.placeholder = 'VPN Subnet';
            break;
        case 'subnet':
            destinationInput.value = '';
            destinationInput.placeholder = 'e.g., 192.168.1.0/24';
            break;
        default:
            destinationInput.placeholder = 'IP/CIDR or "any"';
    }
    
    updateRulesSummary();
}

function updateRulesSummary() {
    const rules = document.querySelectorAll('#firewall-rules-container .card');
    const summaryDiv = document.getElementById('rules-summary');
    
    if (rules.length === 0) {
        summaryDiv.innerHTML = '<p class="mb-0 text-muted">No firewall rules configured - peer will have unrestricted access</p>';
        return;
    }
    
    let allowRules = 0;
    let denyRules = 0;
    
    rules.forEach(rule => {
        const action = rule.querySelector('select[name="firewall_rule_actions[]"]').value;
        if (action === 'ALLOW') allowRules++;
        else denyRules++;
    });
    
    summaryDiv.innerHTML = `
        <div class="row">
            <div class="col-6">
                <span class="badge bg-success">${allowRules} Allow Rules</span>
            </div>
            <div class="col-6">
                <span class="badge bg-danger">${denyRules} Deny Rules</span>
            </div>
        </div>
        <small class="text-muted">Total: ${rules.length} firewall rules configured</small>
    `;
}

function previewIptablesRules() {
    const modal = new bootstrap.Modal(document.getElementById('iptablesModal'));
    const content = document.getElementById('iptablesContent');
    const rules = document.querySelectorAll('#firewall-rules-container .card');
    
    // Show loading state
    content.innerHTML = `
        <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
            <div class="text-muted">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p>Generating preview...</p>
            </div>
        </div>
    `;
    
    modal.show();
    
    if (rules.length === 0) {
        content.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No firewall rules to preview. Add some rules first.
            </div>
        `;
        return;
    }
    
    // Generate preview from current form data
    const peerName = document.getElementById('name').value || 'NewPeer';
    const assignedIp = document.getElementById('assigned_ip').value;
    
    let previewRules = [
        '# Allow established and related connections',
        'iptables -A FORWARD -i wg0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT',
        'iptables -A FORWARD -o wg0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT',
        '# Allow loopback',
        'iptables -A INPUT -i lo -j ACCEPT',
        'iptables -A OUTPUT -o lo -j ACCEPT',
        `# Rules for peer: ${peerName} (${assignedIp})`
    ];
    
    rules.forEach((rule, index) => {
        const name = rule.querySelector('input[name="firewall_rule_names[]"]').value || `Rule ${index + 1}`;
        const action = rule.querySelector('select[name="firewall_rule_actions[]"]').value;
        const type = rule.querySelector('select[name="firewall_rule_types[]"]').value;
        const destination = rule.querySelector('input[name="firewall_rule_destinations[]"]').value || 'any';
        const protocol = rule.querySelector('select[name="firewall_rule_protocols[]"]').value;
        const port = rule.querySelector('input[name="firewall_rule_ports[]"]').value || 'any';
        
        let iptableRule = `iptables -A FORWARD -s ${assignedIp}/32`;
        
        if (destination !== 'any') {
            iptableRule += ` -d ${destination}`;
        }
        
        if (protocol !== 'any') {
            iptableRule += ` -p ${protocol}`;
        }
        
        if (port !== 'any' && protocol !== 'icmp') {
            iptableRule += ` --dport ${port}`;
        }
        
        if (type === 'internet') {
            iptableRule += ' -o !wg0';
        } else {
            iptableRule += ' -i wg0';
        }
        
        iptableRule += ` -j ${action === 'ALLOW' ? 'ACCEPT' : 'DROP'}`;
        iptableRule += ` -m comment --comment "Rule:${name}"`;
        
        previewRules.push(iptableRule);
    });
    
    // Add default drop rules
    previewRules.push(`iptables -A FORWARD -s ${assignedIp}/32 -j DROP`);
    previewRules.push(`iptables -A FORWARD -d ${assignedIp}/32 -j DROP`);
    
    displayIptablesRules(previewRules);
    window.currentIptablesRules = previewRules;
}

// iptables Console Functions
function displayIptablesRules(rules) {
    const content = document.getElementById('iptablesContent');
    
    let html = '<div class="terminal-prompt">root@wireguard-server:~# </div>';
    html += '<span class="terminal-path">./generate-iptables.sh</span><br><br>';
    
    rules.forEach((rule, index) => {
        if (rule.startsWith('#')) {
            html += `<div class="console-line comment" onclick="copyIptableLine(this, ${index})">${rule}</div>`;
        } else if (rule.trim() === '') {
            html += '<br>';
        } else {
            html += `<div class="console-line rule-command" onclick="copyIptableLine(this, ${index})">${rule}</div>`;
        }
    });
    
    html += '<br><div class="terminal-prompt">root@wireguard-server:~# </div>';
    html += '<span class="text-success">‚úì iptables rules generated successfully</span>';
    
    content.innerHTML = html;
}

function copyIptableLine(element, index) {
    const rule = window.currentIptablesRules[index];
    if (rule && rule.trim() !== '' && !rule.startsWith('#')) {
        copyToClipboard(rule, element);
        
        // Visual feedback
        element.classList.add('copied');
        setTimeout(() => {
            element.classList.remove('copied');
        }, 500);
        
        // Show toast notification
        showToast(`Copied: ${rule.substring(0, 50)}${rule.length > 50 ? '...' : ''}`, 'success');
    }
}

function copyAllIptablesRules() {
    if (!window.currentIptablesRules || window.currentIptablesRules.length === 0) {
        showToast('No rules to copy', 'warning');
        return;
    }
    
    const scriptContent = generateIptablesScript(window.currentIptablesRules);
    
    navigator.clipboard.writeText(scriptContent).then(() => {
        showToast(`Copied all ${window.currentIptablesRules.length} iptables rules to clipboard`, 'success');
    }).catch(err => {
        console.error('Failed to copy rules:', err);
        showToast('Failed to copy rules to clipboard', 'error');
    });
}

function downloadIptablesRules() {
    if (!window.currentIptablesRules || window.currentIptablesRules.length === 0) {
        showToast('No rules to download', 'warning');
        return;
    }
    
    const scriptContent = generateIptablesScript(window.currentIptablesRules);
    const peerName = document.getElementById('name').value || 'NewPeer';
    
    const blob = new Blob([scriptContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${peerName}_iptables_rules.sh`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
    
    showToast(`Downloaded iptables script: ${peerName}_iptables_rules.sh`, 'success');
}

function generateIptablesScript(rules) {
    const peerName = document.getElementById('name').value || 'NewPeer';
    const timestamp = new Date().toISOString();
    
    let script = `#!/bin/bash
# iptables rules for WireGuard peer: ${peerName}
# Generated on: ${timestamp}
# 
# Usage: sudo ./$(basename "$0")
# 
# This script applies iptables rules for the specific peer.
# Make sure to review the rules before applying them.

set -e  # Exit on error

echo "Applying iptables rules for peer: ${peerName}"
echo "Generated on: ${timestamp}"
echo ""

`;

    rules.forEach(rule => {
        if (rule.startsWith('#')) {
            script += `${rule}\n`;
        } else if (rule.trim() !== '') {
            script += `echo "Executing: ${rule}"\n`;
            script += `${rule}\n`;
        }
        script += '\n';
    });

    script += `
echo ""
echo "‚úì All iptables rules applied successfully"
echo "Current FORWARD chain rules:"
iptables -L FORWARD -n --line-numbers
`;

    return script;
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

// Initialize firewall rules
document.addEventListener('DOMContentLoaded', function() {
    // Start with unrestricted template selected
    updateRulesSummary();
});
</script>
{% endblock %}
